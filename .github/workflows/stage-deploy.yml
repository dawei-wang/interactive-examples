name: Stage Deployment

on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron: "0 */24 * * *"

  push:
    branches:
      - fix-stage-deploy

  workflow_dispatch:
      inputs:
          notes:
            description: "Notes"
            required: false
            default: ""

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3
              with:
                  path: examples

            - uses: actions/checkout@v3
              with:
                  repository: mdn/bob
                  ref: main
                  path: bob

            - name: Setup Node.js environment
              uses: actions/setup-node@v3
              with:
                  node-version: '16'

            - name: Install dependencies of bob
              run: npm ci
              working-directory: bob

            - name: Build all
              # TODO: bob uses relative paths in bundles. For now we just symlink.
              run:  |
                  rm -rf ./docs
                  npm run build ../examples
              working-directory: bob

            - name: Configure AWS credentials for stage
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.STAGE_AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.STAGE_AWS_ACCESS_KEY_SECRET }}
                  aws-region: us-east-1

            - name: Deploy pages
              run: |
                  aws s3 sync bob/docs/ s3://interactive-examples-stage-ce3e7ea385c68f44/
              working-directory: examples
